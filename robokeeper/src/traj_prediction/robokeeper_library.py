'''
Collection of functions that are useful for the robokeeper
'''
import numpy as np
from sklearn import linear_model
import matplotlib.pyplot as plt
from bagpy import bagreader
import pandas as pd

def traj_linear_reg(x_train, y_train, x_goal):
    '''Predicts the y position of the ball when it crosses the goal line by fitting
    a line to the first few xy-positions of the ball

    Args:
        x_train (list): x coordinate training data
        y_train (list): y coordinate training data
        x_goal (float): position of the goal on the x-axis

    Returns:
        y_predict (float): predicted y postion of the ball when it crosses the goal
    '''
    # Format the input data for the linear regression model function
    x_train = np.array([x_train]).T
    y_train = np.array(y_train)

    # Compute linear regression model
    reg = linear_model.LinearRegression()
    reg.fit(x_train, y_train)
    intercept = reg.intercept_
    slope = reg.coef_

    # Now make the prediction
    y_predict = intercept + slope*x_goal

    return y_predict

def joint_lookup_table(y_pos):
    '''
    Fill in description
    '''
    lookup_dict = {
        0.25: [0.7746839393598904, -1.112170011952318, -0.22166698858911718, 0.0, -0.2347062232120064, -2.345528204517371, 0.1380624842423567],
        0.24: [0.7539745667235369, -1.1021988325348144, -0.2615517062591313, 0.0, -0.2055596987608422, -2.3248188318810175, 0.1380624842423567],
        0.23: [0.732498180285837, -1.09452869452135, -0.29760135492241335, 0.0, -0.176413174309678, -2.304109459244664, 0.1380624842423567],
        0.22: [0.711021793848137, -1.0876255703092321, -0.33288398978434897, 0.0, -0.14803366365986023, -2.281099045204271, 0.1380624842423567],
        0.21: [0.6880113798077442, -1.079955432295768, -0.3681666246462845, 0.0, -0.11965415301004248, -2.258855644965225, 0.1380624842423567],
        0.20: [0.6634669381646586, -1.0753533494876895, -0.399614190501488, 0.0, -0.09280866996291756, -2.2343112033221395, 0.1380624842423567],
        0.19: [0.6373884689188801, -1.069217239076918, -0.43106175635669153, 0.0, -0.0674972145184855, -2.2089997478777073, 0.1380624842423567],
        0.18: [0.6120770134744481, -1.0646151562688395, -0.4617423084105486, 0.0, -0.04141874527270701, -2.1844553062346215, 0.1380624842423567],
        0.17: [0.5852315304273231, -1.0607800872621074, -0.49012181906036634, 0.002301041, -0.0176413174309678, -2.1591438507901897, 0.1380624842423567],
        0.16: [0.5568520197775054, -1.0584790458580682, -0.5092971640940269, 0.029146524451164193, -0.0015340276026928523, -2.1576098231874967, 0.1380624842423567],
        0.15: [0.5292395229290341, -1.0584790458580682, -0.5108311916967199, 0.10891595979119251, 0.0, -2.2089997478777073, 0.1380624842423567],
        0.14: [0.5008600122792163, -1.0584790458580682, -0.5100641778953734, 0.1879183813298744, 0.0, -2.2611566863692643, 0.1380624842423567],
        0.13: [0.47401452923209136, -1.0584790458580682, -0.5108311916967199, 0.2661537890672099, 0.0, -2.3117795972581283, 0.1380624842423567],
        0.12: [0.44716904618496645, -1.0584790458580682, -0.5108311916967199, 0.3405541277978132, 0.0, -2.3593344529416065, 0.1380624842423567],
        0.11: [0.4203235631378415, -1.0584790458580682, -0.5115982054980662, 0.41188641132303083, 0.0, -2.403054239618353, 0.1380624842423567],
        0.10: [0.3934780800907166, -1.0584790458580682, -0.5108311916967199, 0.4809176534442092, 0.0, -2.446007012493753, 0.1380624842423567],
        0.09: [0.3666325970435917, -1.0584790458580682, -0.5115982054980662, 0.5461138265586554, 0.0, -2.483590688759728, 0.1380624842423567],
        0.08: [0.33825308639377394, -1.0584790458580682, -0.5115982054980662, 0.6082419444677158, 0.0, -2.5188733236216634, 0.1380624842423567],
        0.07: [0.3106405895453026, -1.0584790458580682, -0.5108311916967199, 0.6665349933700443, 0.0, -2.548786861874174, 0.1380624842423567],
        0.06: [0.2822610788954848, -1.0584790458580682, -0.5108311916967199, 0.721759987066987, 0.0, -2.5740983173186063, 0.1380624842423567],
        0.05: [0.2531145544443206, -1.0584790458580682, -0.5115982054980662, 0.7708488703531582, 0.0, -2.5948076899549593, 0.1380624842423567],
        0.04: [0.22166698858911718, -1.0584790458580682, -0.5108311916967199, 0.8122676156258652, 0.0, -2.6070799107765024, 0.1380624842423567],
        0.03: [0.19021942273391368, -1.0584790458580682, -0.5108311916967199, 0.8475502504878009, 0.0, -2.609380952180542, 0.1380624842423567],
        0.02: [0.15493678787197807, -1.0584790458580682, -0.5108311916967199, 0.8743957335349258, 0.0, -2.602477827968424, 0.1380624842423567],
        0.01: [0.11812012540734962, -1.0584790458580682, -0.5115982054980662, 0.8912700371645471, 0.0, -2.5825354691334166, 0.1380624842423567],
        0.00: [0.07976943534002831, -1.0584790458580682, -0.5108311916967199, 0.8974061475753186, 0.0, -2.5495538756755205, 0.1380624842423567],
        -0.01: [0.03835069006732131, -1.0584790458580682, -0.5108311916967199, 0.8905030233632008, 0.0, -2.501999019992042, 0.1380624842423567],
        -0.02: [-0.0030680552053857046, -1.0584790458580682, -0.5108311916967199, 0.8743957335349258, 0.0, -2.4421719434870206, 0.1380624842423567],
        -0.03: [-0.04832186948482484, -1.0584790458580682, -0.5115982054980662, 0.8475502504878009, 0.0, -2.370839659961803, 0.1380624842423567],
        -0.04: [-0.09357568376426399, -1.0584790458580682, -0.5108311916967199, 0.8122676156258652, 0.0, -2.288002169416389, 0.1380624842423567],
        -0.05: [-0.1411305394477424, -1.0584790458580682, -0.5115982054980662, 0.7693148427504655, 0.0, -2.19979558226155, 0.1380624842423567],
        -0.06: [-0.18715136752852798, -1.0584790458580682, -0.5115982054980662, 0.7202259594642941, 0.0, -2.1031518432919003, 0.1380624842423567],
        -0.07: [-0.23393920941066, -1.0584790458580682, -0.5108311916967199, 0.6657679795686979, 0.0, -2.0026730353155187, 0.1380624842423567],
        -0.08: [-0.27996003749144555, -1.0584790458580682, -0.5108311916967199, 0.6082419444677158, 0.0, -1.8983591583324049, 0.1380624842423567],
        -0.09: [-0.32291281036684544, -1.0584790458580682, -0.5108311916967199, 0.5461138265586554, 0.0, -1.792511253746598, 0.1380624842423567],
        -0.10: [-0.3666325970435917, -1.0584790458580682, -0.5108311916967199, 0.4801506396428628, 0.0, -1.6835952939554053, 0.1380624842423567],
        -0.11: [-0.4080513423162987, -1.0584790458580682, -0.5115982054980662, 0.410352383720338, 0.0, -1.5739123203628664, 0.1380624842423567],
        -0.12: [-0.44640203238362003, -1.0584790458580682, -0.5108311916967199, 0.33978711399646677, 0.0, -1.463462332968981, 0.1372954704410103],
        -0.13: [-0.48321869484824853, -1.0584790458580682, -0.5108311916967199, 0.2638527476631706, 0.0, -1.3514783179724028, 0.1372954704410103],
        -0.14: [-0.518501329710184, -1.0584790458580682, -0.5108311916967199, 0.18638435372718154, 0.0, -1.2387272891744783, 0.1372954704410103],
        -0.15: [-0.5499488955653875, -1.0584790458580682, -0.5108311916967199, 0.10508089078446038, 0.0, -1.1244422327738606, 0.1372954704410103],
        -0.16: [-0.5729593096057803, -1.0584790458580682, -0.5131322331007591, 0.03911770386866773, 0.0, -1.0362356456190218, 0.1372954704410103],
        -0.17: [-0.5729593096057803, -1.0584790458580682, -0.5138992469021055, 0.03911770386866773, 0.0, -1.0362356456190218, 0.1372954704410103],
        -0.18: [-0.6327863861108015, -1.0584790458580682, -0.5100641778953734, -0.15416977407063165, 0.0, -0.7815870635720082, 0.1372954704410103],
        -0.19: [-0.6542627725485015, -1.0584790458580682, -0.5100641778953734, -0.2523475406429742, 0.0, -0.6619329105619658, 0.1372954704410103],
        -0.20: [-0.6719040899794693, -1.0584790458580682, -0.5108311916967199, -0.35512739002339533, 0.0, -0.5407447299492304, 0.1372954704410103],
        -0.21: [-0.6880113798077442, -1.0584790458580682, -0.5108311916967199, -0.46481036361593425, 0.0, -0.415721480329763, 0.1372954704410103],
        -0.22: [-0.7002836006292871, -1.0584790458580682, -0.5108311916967199, -0.5844645166259768, 0.0, -0.2845621202995241, 0.1372954704410103],
        -0.23: [-0.7079537386427514, -1.0584790458580682, -0.5108311916967199, -0.7163908904575621, 0.0, -0.14496560845447454, 0.1372954704410103],
        -0.24: [-0.711021793848137, -1.0584790458580682, -0.5108311916967199, -0.8651915679187687, 0.0, 0.006136110410771409, 0.1372954704410103],
        -0.25: [-0.7064197110400584, -1.0584790458580682, -0.5108311916967199, -1.0423717560297932, 0.0, 0.1787142157137173, 0.1372954704410103]
    }

    y_pos_cm = round(y_pos, 2)
    # print(lookup_dict[y_pos_cm])
    return lookup_dict[y_pos_cm]

def get_rosbag_data():
    '''
    Extracts position data stored in a rosbag file

    Only needed for testing
    '''
    bag = bagreader('subset_second.bag')
    data_rosbag = bag.message_by_topic('/Goalie_coord')
    data = pd.read_csv(data_rosbag)
    return data

def main():
    '''
    Main is just used to test the above functions
    '''
    data = get_rosbag_data().to_numpy()
    x_data = data[:, 1]
    y_data = data[:, 2]

    n = 10
    x_train = x_data[0:n]
    y_train = y_data[0:n]

    x_goal = -1.27  # As of Nov 21, 8pm
    y_predict = traj_linear_reg(x_train, y_train, x_goal)

    print(y_predict)

    joint_lookup_table(-0.0239328)

if __name__ == '__main__':
    main()
